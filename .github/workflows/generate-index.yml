name: Generate Docs Index

on:
  repository_dispatch:
    types: [generate-docs-index]

permissions:
  contents: write

jobs:
  generate-index:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate index.html from subdirectories
        run: |
          echo '<!DOCTYPE html>
          <html lang="ja">
          <head>
            <meta charset="UTF-8">
            <title>Project Docs</title>
            <style>
              :root {
                color-scheme: dark;
              }
              body {
                margin: 0;
                background-color: #121212;
                color: #e0e0e0;
                font-family: "Segoe UI", "Helvetica Neue", sans-serif;
                height: 94dvh;
                overflow: hidden;
                display: flex;
                justify-content: center;
                align-items: center;
                padding: 2rem;
              }
              .container {
                text-align: center;
                max-width: 600px;
                width: 100%;
                max-height: 80vh;
                background-color: #1e1e1e;
                padding: 2rem;
                border-radius: 16px;
                box-shadow: 0 0 20px rgba(0,0,0,0.3);
                display: flex;
                flex-direction: column;
              }
              .scroll-area {
                overflow-y: auto;
                flex-grow: 1;
              }
              h1 {
                margin-bottom: 1.5rem;
                font-size: 1.8rem;
                color: #ffffff;
              }
              ul {
                list-style-type: none;
                padding: 0;
                margin: 0;
              }
              li {
                margin: 0.75rem 0;
              }
              a {
                text-decoration: none;
                color: #80c9ff;
                font-size: 1.1rem;
                transition: color 0.2s ease;
              }
              a:hover {
                color: #a8dcff;
                text-decoration: underline;
              }
              .footer {
                font-size: 0.9rem;
                color: #aaaaaa;
                margin-top: 1rem;
              }
            </style>
          </head>
          <body>
            <div class="container">
              <h1>ðŸ“š Project Documentation</h1>
              <div class="scroll-area">
                <ul>' > index.html

          for dir in */; do
            if [[ "$dir" == ".git/" ]] || [[ "$dir" == ".github/" ]]; then continue; fi
            name=$(basename "$dir")
            echo "                  <li><a href=\"./$name/\">$name</a></li>" >> index.html
          done

          echo '                </ul>
              </div>
              <div class="footer">Generated automatically on '$(date -u)'</div>
            </div>
          </body>
          </html>' >> index.html

      - name: Commit and push index.html
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add index.html
          git commit -m "chore: auto-generate docs index [skip ci] ($(date +%s))" || echo "No changes to commit"
          git push

      - name: Wait a few seconds for GitHub to update refs
        run: sleep 10

      - name: Trigger deploy manually
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          event-type: deploy
